'use strict';

var jstransformer = require('jstransformer');
<<<<<<< HEAD
var resolve = require('resolve');

module.exports = filter;

function getMinifyTransformerName(outputFormat) {
  switch (outputFormat) {
    case 'js':
      return 'uglify-js';
    case 'css':
      return 'clean-css';
  }
}

function filter(name, str, options, currentDirectory, funcName) {
  funcName = funcName || 'render';
  var trPath;
  try {
    try {
      trPath = resolve.sync('jstransformer-' + name, {
        basedir: currentDirectory || process.cwd(),
      });
    } catch (ex) {
      trPath = require.resolve('jstransformer-' + name);
    }
  } catch (ex) {
    var err = new Error('unknown filter ":' + name + '"');
    err.code = 'UNKNOWN_FILTER';
    throw err;
  }
  var tr = jstransformer(require(trPath));
  // TODO: we may want to add a way for people to separately specify "locals"
  var result = tr[funcName](str, options, options).body;
  if (options && options.minify) {
    var minifyTranformer = getMinifyTransformerName(tr.outputFormat);
    if (minifyTranformer) {
      try {
        result = filter(minifyTranformer, result, null, currentDirectory);
=======
var uglify = require('uglify-js');
var CleanCSS = require('clean-css');
var resolve = require('resolve');

module.exports = filter;
function filter(name, str, options, currentDirectory, funcName) {
  funcName = funcName || 'render';
  var tr;
  try {
    try {
      tr = require(resolve.sync('jstransformer-' + name, {basedir: currentDirectory || process.cwd()}));
    } catch (ex) {
      tr = require('jstransformer-' + name);
    }
    tr = jstransformer(tr);
  } catch (ex) {}
  if (tr) {
    // TODO: we may want to add a way for people to separately specify "locals"
    var result = tr[funcName](str, options, options).body;
    if (options && options.minify) {
      try {
        switch (tr.outputFormat) {
          case 'js':
            result = uglify.minify(result, {fromString: true}).code;
            break;
          case 'css':
            result = new CleanCSS().minify(result).styles;
            break;
        }
>>>>>>> remotes/origin/main
      } catch (ex) {
        // better to fail to minify than output nothing
      }
    }
<<<<<<< HEAD
  }
  return result;
=======
    return result;
  } else {
    var err = new Error('unknown filter ":' + name + '"');
    err.code = 'UNKNOWN_FILTER';
    throw err;
  }
>>>>>>> remotes/origin/main
}
